{"pageProps":{"postData":{"id":"MySQL 存储emoji","contentHtml":"<p>mysql存储字符串时，如果字符串还有emoji，会存储失败，这是在保存之前要将emoji转码然后在api请求获取数据时重新解码返回带emoji的字符</p>\n<pre><code><span>// 表情转码</span>\n<span>function</span> <span>utf16toEntities</span>(<span>str</span>) {\n  <span>const</span> patt = <span>/[\\ud800-\\udbff][\\udc00-\\udfff]/g</span> <span>// 检测utf16字符正则</span>\n  str = str.<span>replace</span>(patt, <span>(<span>char</span>) =></span> {\n    <span>let</span> H\n    <span>let</span> L\n    <span>let</span> code\n    <span>let</span> s\n\n    <span>if</span> (char.<span>length</span> === <span>2</span>) {\n      H = char.<span>charCodeAt</span>(<span>0</span>) <span>// 取出高位</span>\n      L = char.<span>charCodeAt</span>(<span>1</span>) <span>// 取出低位</span>\n      code = (H - <span>0xD800</span>) * <span>0x400</span> + <span>0x10000</span> + L - <span>0xDC00</span> <span>// 转换算法</span>\n      s = <span>`&#x26;#<span>${code}</span>;`</span>\n    } <span>else</span> {\n      s = char\n    }\n\n    <span>return</span> s\n  })\n\n  <span>return</span> str\n}\n<span>// 表情解码</span>\n<span>function</span> <span>entitiestoUtf16</span>(<span>strObj</span>) {\n  <span>const</span> patt = <span>/&#x26;#\\d+;/g</span>\n  <span>const</span> arr = strObj.<span>match</span>(patt) || []\n\n  <span>let</span> H\n  <span>let</span> L\n  <span>let</span> code\n\n  <span>for</span> (<span>let</span> i = <span>0</span>; i &#x3C; arr.<span>length</span>; i += <span>1</span>) {\n    code = arr[i]\n    code = code.<span>replace</span>(<span>'&#x26;#'</span>, <span>''</span>).<span>replace</span>(<span>';'</span>, <span>''</span>)\n    <span>// 高位</span>\n    H = <span>Math</span>.<span>floor</span>((code - <span>0x10000</span>) / <span>0x400</span>) + <span>0xD800</span>\n    <span>// 低位</span>\n    L = ((code - <span>0x10000</span>) % <span>0x400</span>) + <span>0xDC00</span>\n    code = <span>`&#x26;#<span>${code}</span>;`</span>\n    <span>const</span> s = <span>String</span>.<span>fromCharCode</span>(H, L)\n    strObj = strObj.<span>replace</span>(code, s)\n  }\n  <span>return</span> strObj\n}</code></pre>\n","title":"MySQL 存储emoji","date":"2021-03-04T20:40:51.000Z","description":"description","tag":"mysql"}},"__N_SSG":true}