<!DOCTYPE html><html lang="zh-Hans"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><link rel="icon" href="/favicon.ico"/><meta name="description" content="Learn how to build a personal website using Next.js"/><meta property="og:image" content="https://og-image.now.sh/Swordword&#x27;s%20blog.png?theme=light&amp;md=0&amp;fontSize=75px&amp;images=https%3A%2F%2Fassets.vercel.com%2Fimage%2Fupload%2Ffront%2Fassets%2Fdesign%2Fnextjs-black-logo.svg"/><meta name="og:title" content="Swordword&#x27;s blog"/><title>NodeJS 使用ffmpeg放大视频</title><meta name="next-head-count" content="7"/><link rel="preload" href="/_next/static/css/876d048b5dab7c28.css" as="style"/><link rel="stylesheet" href="/_next/static/css/876d048b5dab7c28.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-a03f34702f60fafc.js" defer=""></script><script src="/_next/static/chunks/framework-2c79e2a64abdb08b.js" defer=""></script><script src="/_next/static/chunks/main-7c48f75ce2db1491.js" defer=""></script><script src="/_next/static/chunks/pages/_app-e272e05dd28ef959.js" defer=""></script><script src="/_next/static/chunks/130-b952c5d507d712ac.js" defer=""></script><script src="/_next/static/chunks/749-555cb8054e68346e.js" defer=""></script><script src="/_next/static/chunks/241-e8e3e8578555aa77.js" defer=""></script><script src="/_next/static/chunks/783-464c81cbfd42177e.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bid%5D-4108770bd2d21ccc.js" defer=""></script><script src="/_next/static/Xajds82wgprlLoQfKFbdB/_buildManifest.js" defer=""></script><script src="/_next/static/Xajds82wgprlLoQfKFbdB/_ssgManifest.js" defer=""></script></head><body><div id="__next"><style data-emotion="css dbbey5">.css-dbbey5{width:100vw;height:100vh;overflow-y:scroll;background:#eee;color:#3c4858;padding-bottom:50px;}</style><div class="css-dbbey5"><style data-emotion="css gpj3uu">.css-gpj3uu{width:100%;height:50px;color:#fff;background-color:rgba(47,65,84,0.7);box-shadow:0 2px 5px 0 rgb(0 0 0 / 16%),0 2px 10px 0 rgb(0 0 0 / 12%);position:fixed;top:0;left:0;z-index:2;}</style><div class="css-gpj3uu"><style data-emotion="css qjodyr">.css-qjodyr{width:1100px;height:100%;margin:auto;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:justify;-webkit-justify-content:space-between;justify-content:space-between;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}</style><div class="css-qjodyr"><a href="/"><style data-emotion="css 19m5m0c">.css-19m5m0c{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:start;-ms-flex-pack:start;-webkit-justify-content:flex-start;justify-content:flex-start;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;cursor:pointer;}</style><div class="css-19m5m0c"><style data-emotion="css l2tq7e">.css-l2tq7e{width:30px;height:30px;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}</style><div class="css-l2tq7e"><style data-emotion="css brme6v">.css-brme6v{width:24px;height:24px;margin-left:6px;}</style><svg class="icon css-brme6v" aria-hidden="true"><use xlink:href="#icon-sword"></use></svg></div><style data-emotion="css 879ic9">.css-879ic9{margin-left:20px;}</style><div class="css-879ic9">Swordword</div></div></a><style data-emotion="css fhxb3m">.css-fhxb3m{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}</style><div class="css-fhxb3m"><a href="/"><style data-emotion="css kfc5ms">.css-kfc5ms{width:100px;height:50px;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;cursor:pointer;}.css-kfc5ms:hover{color:#30A9DE;background-color:rgba(0,0,0,0.1);}</style><div class="css-kfc5ms"><div class="css-l2tq7e"><svg class="icon css-brme6v" aria-hidden="true"><use xlink:href="#icon-home"></use></svg></div><style data-emotion="css 1a2afmv">.css-1a2afmv{margin-left:10px;}</style><div class="css-1a2afmv">首页</div></div></a><style data-emotion="css 1lwiia1">.css-1lwiia1{width:100px;height:50px;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;cursor:pointer;position:relative;}.css-1lwiia1:hover .nav-list{display:block;}</style><div class="css-1lwiia1"><div class="css-l2tq7e"><svg class="icon css-brme6v" aria-hidden="true"><use xlink:href="#icon-list"></use></svg></div><div class="css-1a2afmv">索引</div><style data-emotion="css su4vv2">.css-su4vv2{-webkit-transition:3s ease-out;transition:3s ease-out;display:none;width:100px;position:absolute;top:50px;left:0;background-color:rgba(47,65,84,0.7);box-shadow:0 2px 5px 0 rgb(0 0 0 / 16%),0 2px 10px 0 rgb(0 0 0 / 12%);}</style><div class="nav-list css-su4vv2"><a href="/archive"><div class="css-kfc5ms"><div class="css-l2tq7e"><svg class="icon css-brme6v" aria-hidden="true"><use xlink:href="#icon-guidang"></use></svg></div><div class="css-1a2afmv">归档</div></div></a><a href="/category"><div class="css-kfc5ms"><div class="css-l2tq7e"><svg class="icon css-brme6v" aria-hidden="true"><use xlink:href="#icon-leimupinleifenleileibie2"></use></svg></div><div class="css-1a2afmv">分类</div></div></a><a href="/tag"><div class="css-kfc5ms"><div class="css-l2tq7e"><svg class="icon css-brme6v" aria-hidden="true"><use xlink:href="#icon-tag1"></use></svg></div><div class="css-1a2afmv">标签</div></div></a></div></div><a href="/about"><div class="css-kfc5ms"><div class="css-l2tq7e"><svg class="icon css-brme6v" aria-hidden="true"><use xlink:href="#icon-lianhe4"></use></svg></div><div class="css-1a2afmv">关于</div></div></a><a href="/rss"><div class="css-kfc5ms"><div class="css-l2tq7e"><svg class="icon css-brme6v" aria-hidden="true"><use xlink:href="#icon-rss"></use></svg></div><div class="css-1a2afmv">RSS</div></div></a><div class="css-l2tq7e"><svg class="icon css-brme6v" aria-hidden="true"><use xlink:href="#icon-OOjs_UI_icon_search-ltr"></use></svg></div><div class="css-1a2afmv"><div class="css-l2tq7e"><svg class="icon css-brme6v" aria-hidden="true"><use xlink:href="#icon-sun"></use></svg></div></div></div></div></div><style data-emotion="css 1739oy8">.css-1739oy8{z-index:1;}</style><div class="css-1739oy8"><style data-emotion="css z6d19t">.css-z6d19t{width:100%;height:350px;position:relative;background:url(/_next/static/media/banner.eb35a883.jpg) center;}</style><div class="css-z6d19t"></div></div><style data-emotion="css 3vwp2t">.css-3vwp2t{position:relative;width:1100px;background:#fff;padding:50px 100px;margin:-150px auto 50px;border-radius:8px;}</style><main class="css-3vwp2t"><article style="color:#3c4858"><style data-emotion="css yrjjfw">.css-yrjjfw{height:70px;margin:0;line-height:70px;text-align:center;font-size:40px;}</style><h1 class="css-yrjjfw">NodeJS 使用ffmpeg放大视频</h1><style data-emotion="css faxeo3">.css-faxeo3{margin-left:250px;}</style><div class="css-faxeo3"><style data-emotion="css hc4w4d">.css-hc4w4d{height:40px;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:start;-ms-flex-pack:start;-webkit-justify-content:flex-start;justify-content:flex-start;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}</style><div class="css-hc4w4d"><style data-emotion="css 12qt3ml">.css-12qt3ml{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:start;-ms-flex-pack:start;-webkit-justify-content:flex-start;justify-content:flex-start;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}</style><div class="css-12qt3ml"><style data-emotion="css 2ldgmb">.css-2ldgmb{color:#30a9de;}</style><small class="css-2ldgmb"><div class="css-l2tq7e"><svg class="icon css-brme6v" aria-hidden="true"><use xlink:href="#icon-time"></use></svg></div></small><style data-emotion="css qq1p72">.css-qq1p72{margin-left:10px;margin-right:20px;cursor:pointer;}</style><small class="css-qq1p72"><a href="/archive"><span><time dateTime="2021-04-12T13:43:19.000Z">21-04-12</time></span></a></small></div><div class="css-12qt3ml"><small class="css-2ldgmb"><div class="css-l2tq7e"><svg class="icon css-brme6v" aria-hidden="true"><use xlink:href="#icon-leimupinleifenleileibie2"></use></svg></div></small><small class="css-qq1p72"><a href="/category"><span>前往分类</span></a></small></div><div class="css-12qt3ml"><small class="css-2ldgmb"><div class="css-l2tq7e"><svg class="icon css-brme6v" aria-hidden="true"><use xlink:href="#icon-tag1"></use></svg></div></small><small class="css-qq1p72"><a href="/tag/nodejs"><span>NodeJS<!-- --> </span></a></small></div></div></div><style data-emotion="css h25mx1">.css-h25mx1{border-bottom:1px solid #30a9de;margin-top:20px;margin-bottom:20px;}</style><div class="css-h25mx1"></div><div><h4 id="user-content-问题"><a href="#%E9%97%AE%E9%A2%98" aria-hidden="true" tabindex="-1"><span></span></a>问题</h4>
<p>最近接到一个需求，将几百个不到1mb的视频扩充到20m以上</p>
<h4 id="user-content-处理"><a href="#%E5%A4%84%E7%90%86" aria-hidden="true" tabindex="-1"><span></span></a>处理</h4>
<p>视频处理只听说过<a>ffmpeg</a>,自然就使用了node包 <a href="https://github.com/fluent-ffmpeg/node-fluent-ffmpeg">fluent-ffmpeg</a></p>
<p><code>const ffmpeg = require('fluent-ffmpeg')</code></p>
<p>首先想到的是修改视频的分辨率，之前的分辨率一直是 640, 但是通过一番查找发现视频的尺寸其实与分辨率并没有太大的关系。</p>
<p>码率：数据传输时单位时间传送的数据位数，单位是 kbps 或 mbps</p>
<p><strong>视频尺寸 = 码率 * 时长 / 8</strong></p>
<p>视频的时长自然没法改变，所以可以通过添加视频的码率增加视频尺寸</p>
<p>通过 ffmpeg 的 ffprobe 查询当前视频的码率是多少</p>
<pre><code>ffmpeg.<span>ffprobe</span>(filePath, <span>(<span>err, data</span>) =></span> {
      <span>console</span>.<span>log</span>(<span>'data'</span>, data.<span>format</span>.<span>bit_rate</span>,data.<span>format</span>.<span>size</span>)
    })</code></pre>
<p><img src="http://img.massivejohn.com/image-20210412162835650.png" alt="image-20210412162835650"></p>
<p>可以得到一个测试视频的码率是 485935，大小大概 570k</p>
<p>因为按照比例将码率扩大40倍，<code>ffmpeg(filePath).videoBitrate(40 * originBitrate)</code>发现视频尺寸并没有到达 20mb 以上。。。</p>
<p>又将码率从 2 开始慢慢增加，发现当码率增加到一定的倍数后，视频尺寸与码率就不在按照正比例增加了。可能是因为视频的分辨率限制了码率的最大值，分辨率就只有640，码率增加过大也没有任何意义了。也可能 ffmpeg 内部对码率与分辨率做了限制。</p>
<p>那就去修改分辨率吧，将分辨率设置为 1920 在将码率设置为 20 mbps，这样只要视频的长度大于 8</p>
<p>s 时视频的尺寸就超过了20m</p>
<pre><code>     <span>ffmpeg</span>(filePath)
        .<span>videoBitrate</span>(<span>'20000k'</span>)
        .<span>size</span>(<span>`1920x?`</span>)
        .<span>save</span>(<span>`<span>${dir}</span>/<span>${name}</span>copy.mp4`</span>)
        .<span>on</span>(<span>'end'</span>, <span>() =></span> {
          <span>resolve</span>()
        })
        .<span>on</span>(<span>'error'</span>, <span>(<span>err</span>) =></span> {
          <span>console</span>.<span>log</span>(<span>'err'</span>, err)
          <span>reject</span>(<span>'error'</span>)
        })</code></pre>
<p>当然，最终也没有用到 ffprobe 读取的视频信息。</p>
<p>查找过程中找了一些别的信息值得记录一下：</p>
<p>分辨率：每一帧图像的大小，不同的分辨率要采用不同的位率</p>
<p>帧率：FPS(Frames PerSecond) 每秒钟播放图片的帧数</p>
<p>波特率：每秒传送的比特(bit)数，和码率看起来是一个东西。</p>
<h4 id="user-content-结论"><a href="#%E7%BB%93%E8%AE%BA" aria-hidden="true" tabindex="-1"><span></span></a>结论</h4>
<p>视频尺寸是由码率和视频时长决定了，而码率的最大值是受视频的分辨率影响（或者只是在ffmpeg之中）</p>
</div></article></main></div><style data-emotion="css 1st94pw">.css-1st94pw{text-align:center;height:30px;line-height:30px;color:#333;}</style><div class="css-1st94pw"><a href="https://beian.miit.gov.cn/" target="_blank" rel="noreferrer">京ICP备19054504号-2</a></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postData":{"id":"NodeJS 使用ffmpeg放大视频","contentHtml":"\u003ch4 id=\"user-content-问题\"\u003e\u003ca href=\"#%E9%97%AE%E9%A2%98\" aria-hidden=\"true\" tabindex=\"-1\"\u003e\u003cspan\u003e\u003c/span\u003e\u003c/a\u003e问题\u003c/h4\u003e\n\u003cp\u003e最近接到一个需求，将几百个不到1mb的视频扩充到20m以上\u003c/p\u003e\n\u003ch4 id=\"user-content-处理\"\u003e\u003ca href=\"#%E5%A4%84%E7%90%86\" aria-hidden=\"true\" tabindex=\"-1\"\u003e\u003cspan\u003e\u003c/span\u003e\u003c/a\u003e处理\u003c/h4\u003e\n\u003cp\u003e视频处理只听说过\u003ca\u003effmpeg\u003c/a\u003e,自然就使用了node包 \u003ca href=\"https://github.com/fluent-ffmpeg/node-fluent-ffmpeg\"\u003efluent-ffmpeg\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003econst ffmpeg = require('fluent-ffmpeg')\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e首先想到的是修改视频的分辨率，之前的分辨率一直是 640, 但是通过一番查找发现视频的尺寸其实与分辨率并没有太大的关系。\u003c/p\u003e\n\u003cp\u003e码率：数据传输时单位时间传送的数据位数，单位是 kbps 或 mbps\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e视频尺寸 = 码率 * 时长 / 8\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e视频的时长自然没法改变，所以可以通过添加视频的码率增加视频尺寸\u003c/p\u003e\n\u003cp\u003e通过 ffmpeg 的 ffprobe 查询当前视频的码率是多少\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003effmpeg.\u003cspan\u003effprobe\u003c/span\u003e(filePath, \u003cspan\u003e(\u003cspan\u003eerr, data\u003c/span\u003e) =\u003e\u003c/span\u003e {\n      \u003cspan\u003econsole\u003c/span\u003e.\u003cspan\u003elog\u003c/span\u003e(\u003cspan\u003e'data'\u003c/span\u003e, data.\u003cspan\u003eformat\u003c/span\u003e.\u003cspan\u003ebit_rate\u003c/span\u003e,data.\u003cspan\u003eformat\u003c/span\u003e.\u003cspan\u003esize\u003c/span\u003e)\n    })\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cimg src=\"http://img.massivejohn.com/image-20210412162835650.png\" alt=\"image-20210412162835650\"\u003e\u003c/p\u003e\n\u003cp\u003e可以得到一个测试视频的码率是 485935，大小大概 570k\u003c/p\u003e\n\u003cp\u003e因为按照比例将码率扩大40倍，\u003ccode\u003effmpeg(filePath).videoBitrate(40 * originBitrate)\u003c/code\u003e发现视频尺寸并没有到达 20mb 以上。。。\u003c/p\u003e\n\u003cp\u003e又将码率从 2 开始慢慢增加，发现当码率增加到一定的倍数后，视频尺寸与码率就不在按照正比例增加了。可能是因为视频的分辨率限制了码率的最大值，分辨率就只有640，码率增加过大也没有任何意义了。也可能 ffmpeg 内部对码率与分辨率做了限制。\u003c/p\u003e\n\u003cp\u003e那就去修改分辨率吧，将分辨率设置为 1920 在将码率设置为 20 mbps，这样只要视频的长度大于 8\u003c/p\u003e\n\u003cp\u003es 时视频的尺寸就超过了20m\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e     \u003cspan\u003effmpeg\u003c/span\u003e(filePath)\n        .\u003cspan\u003evideoBitrate\u003c/span\u003e(\u003cspan\u003e'20000k'\u003c/span\u003e)\n        .\u003cspan\u003esize\u003c/span\u003e(\u003cspan\u003e`1920x?`\u003c/span\u003e)\n        .\u003cspan\u003esave\u003c/span\u003e(\u003cspan\u003e`\u003cspan\u003e${dir}\u003c/span\u003e/\u003cspan\u003e${name}\u003c/span\u003ecopy.mp4`\u003c/span\u003e)\n        .\u003cspan\u003eon\u003c/span\u003e(\u003cspan\u003e'end'\u003c/span\u003e, \u003cspan\u003e() =\u003e\u003c/span\u003e {\n          \u003cspan\u003eresolve\u003c/span\u003e()\n        })\n        .\u003cspan\u003eon\u003c/span\u003e(\u003cspan\u003e'error'\u003c/span\u003e, \u003cspan\u003e(\u003cspan\u003eerr\u003c/span\u003e) =\u003e\u003c/span\u003e {\n          \u003cspan\u003econsole\u003c/span\u003e.\u003cspan\u003elog\u003c/span\u003e(\u003cspan\u003e'err'\u003c/span\u003e, err)\n          \u003cspan\u003ereject\u003c/span\u003e(\u003cspan\u003e'error'\u003c/span\u003e)\n        })\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e当然，最终也没有用到 ffprobe 读取的视频信息。\u003c/p\u003e\n\u003cp\u003e查找过程中找了一些别的信息值得记录一下：\u003c/p\u003e\n\u003cp\u003e分辨率：每一帧图像的大小，不同的分辨率要采用不同的位率\u003c/p\u003e\n\u003cp\u003e帧率：FPS(Frames PerSecond) 每秒钟播放图片的帧数\u003c/p\u003e\n\u003cp\u003e波特率：每秒传送的比特(bit)数，和码率看起来是一个东西。\u003c/p\u003e\n\u003ch4 id=\"user-content-结论\"\u003e\u003ca href=\"#%E7%BB%93%E8%AE%BA\" aria-hidden=\"true\" tabindex=\"-1\"\u003e\u003cspan\u003e\u003c/span\u003e\u003c/a\u003e结论\u003c/h4\u003e\n\u003cp\u003e视频尺寸是由码率和视频时长决定了，而码率的最大值是受视频的分辨率影响（或者只是在ffmpeg之中）\u003c/p\u003e\n","title":"NodeJS 使用ffmpeg放大视频","date":"2021-04-12T13:43:19.000Z","description":"description","tag":"NodeJS"}},"__N_SSG":true},"page":"/posts/[id]","query":{"id":"NodeJS 使用ffmpeg放大视频"},"buildId":"Xajds82wgprlLoQfKFbdB","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>